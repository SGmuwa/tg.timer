# kt.pizza
Данный репозиторий содержит бот оповещения о пицце:

* `telegram.py`

## Пример запуска

### Unix like

```bash
./telegram.py
```

### WindowsNT

```cmd
python3 telegram.py
```

## Переменные среды

| Название                         | Значение по-умолчанию                 | Допустимые значения                                                          | Описание   |
|----------------------------------|---------------------------------------|------------------------------------------------------------------------------|------------|
| `LOGURU_LEVEL`                   | `DEBUG`                               | `TRACE`, `DEBUG`, `INFO`, `WARNING`, `ERROR`                                 | Уровень журналирования информации в консоль. |
| `TELEGRAM_SECRET_PATH`           | `./secret.json5`                      | any path example `/run/checks/secret.json5`                                  | Место в файловой системе, где хранятся секретные настройки. |
| `TELEGRAM_SECRET`                | `None`                                | Содержимое файла `secret.json5`                                              | Вместо пути `TELEGRAM_SECRET_PATH` можно передать содержимое json файла прям в этой переменной. |
| `MAX_PAST_TIME_S`                | `5400`                                | 0.0 <= x < 86400.0                                                           | Когда событие уже прошло, сколько времени отсчитывать в прошлое? |
| `PARSE_TIMEZONE_DEFAULT`         | `UTC`                                 | Строка timezone                                                              | Если пользователь не указал часовой пояс, какой часовой пояс считать? |
| `SCHEDULER_SLEEP_START_S`        | `1.0`                                 | 1.0 <= x < 3155673600.0                                                      | Первоначальный интервал между обработками очереди сообщений |
| `SCHEDULER_SLEEP_ALWAYS_ADD_S`   | `0.01`                                | 0.0 <= x < 3155673600.0                                                      | Сколько добавлять времени к интервалу после каждой обработки сообщения |
| `SCHEDULER_SLEEP_FLOOD_STRATEGY` | `remember per instance`               | `remember per scheduler`, `remember per instance`, `just wait`, `don't wait`, `exit scheduler`, `exit program` | Как реагировать на ошибку `420` `FLOOD` (`FloodWaitError`). Ошибка обозначает, что Telegram сервер просит подождать заданное количество времени. Подробнее ниже. |

Если вдруг заданы одновременно `TELEGRAM_SECRET_PATH` и `TELEGRAM_SECRET`, то будет использован `TELEGRAM_SECRET`.

Значения `SCHEDULER_SLEEP_FLOOD_STRATEGY`:

1. `remember per scheduler` — Будет ждать не только на текущую итерацию, которое попросил подождать Telegram server, но и каждый интервал между обработками будет задан в значение от Telegram сервера, до тех пор, пока очередь сообщений не пуста. В случае, если Telegram server попросит подождать меньше, чем текущий интервал, то значение Telegram server будет проигнорировано.
2. `remember per instance` — Будет ждать не только на текущую итерацию, которое попросил подождать Telegram server, но и каждый интервал между обработками будет задан в значение от Telegram сервера. В случае, если очередь будет опустевшая, то интервал сбросится до значения, которое прислал Telegram сервер, чтобы сбросить влияние `SCHEDULER_SLEEP_ALWAYS_ADD_S`. В случае, если Telegram server попросит подождать меньше, чем текущий интервал, то значение Telegram server будет проигнорировано.
3. `just wait` — При получении ошибки вместо ожидания обычного интервала будет ждать количество секунд, полученное от Telegram Server один раз, а затем продолжит работу в прежнем режиме. Значение Telegram Server нигде не запоминается, кроме логов.
4. `don't wait` — Игнорировать ошибку
5. `exit scheduler` — Останавливает работу scheduler.
6. `exit program` — Останавливает работу программы.

## Заполнение secret.json

Есть два варианта заполнения `secret.json5`

1. Безопасный двухшаговый
2. Простой одношаговый

### 1. Безопасный двухшаговый

Если не хотите делиться `api_id` и `api_hash` с хостингом где будет крутиться скрипт, то следуйте шагам.

#### Шаг 1

Сначала запустите telegram.py с заполненными полями как в файле `step1.example.secret.json5`. Вам программа должна выдать `session_and_auth_key`.

#### Шаг 2

Удалите лишние поля и добавьте необходимые как в файле `step2.example.secret.json5`.

### 2. Простой одношаговый

Объедините два файла

1. `step1.example.secret.json5`
2. `step2.example.secret.json5`

в один и заполните поля. Дублирующие поля удалите.

Для заполнения `session_and_auth_key` запустите сначала без поля `session_and_auth_key`, скрипт подскажет его значение.
